<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>データプロット</title>
	<link rel="icon" href="https://birdwatcheryt.github.io/image/icon.ico">
	<link rel="stylesheet" type="text/css" href="https://birdwatcheryt.github.io/footer.css">
	<style>
		button {
			padding: 6px;
		}

		table {
			border: 1px solid;
			border-collapse: collapse;
			margin: 10px;
		}

		td,
		th {
			text-align: center;
			padding: 3px;
		}

		.output tr {
			border: 1px solid;
			height: 10px;
		}

		.output td,
		.output th {
			border: 1px solid;
			text-align: center;
			padding-left: 10px;
			padding-right: 10px;
		}
	</style>
</head>

<body>
	<p><a href="../software.html">←Softwares</a></p>

	<h1>データプロット</h1>
	列ごとのデータをプロットします。
	<p>
		<textarea id="input" rows="20" cols="40">
-10	30	1
0	10	4
10	-20	9
20	30	16
30	50	25
40	20	36
</textarea>
	</p>
	<p>
		区切り文字
		<select id="sep">
			<option value="tab">タブ</option>
			<option value="comma">カンマ</option>
			<option value="space">スペース</option>
		</select>
	</p>
	<p>
		最初の列を共通のx軸にする
		<input type="checkbox" id="firstIsX">
	</p>
	<table>
		<tr>
			<td>線の太さ</td>
			<td><input id="lineWidth" type="number" value="1"></td>
		<tr>
		<tr>
			<td>マーカーサイズ</td>
			<td> <input id="markerSize" type="number" value="5"> </td>
		<tr>
		<tr>
			<td>フォントサイズ</td>
			<td><input id="fontSize" type="number" value="20"></td>
		</tr>
		<tr>
			<td>目盛りの数</td>
			<td><input id="gridNum" type="number" value="5"></td>
		</tr>
		<tr>
			<td>余白</td>
			<td><input id="margin" type="number" value="50"></td>
		</tr>
		<tr>
			<td>有効桁数</td>
			<td><input id="precision" type="number" value="5"></td>
		</tr>
		<tr>
			<td>幅</td>
			<td><input id="width" type="number" value="800"></td>
		</tr>
		<tr>
			<td>高さ</td>
			<td><input id="height" type="number" value="500"></td>
		</tr>
	</table>
	<button onclick="onClick();">plot</button>

	<h2>グラフ</h2>
	<span id="graph"></span>
	<h2>読み込み結果</h2>
	<span id="data"></span>

	<script>
		const COLORS = ["blue", "red", "green", "gold", "cyan", "magenta", "black"];
		function makeTable(data, firstIsX) {
			let str = '<table class="output">';
			for (let j = 0; j < data[0].length; ++j) {
				const flag = (firstIsX && j == 0);
				const intercept = firstIsX ? -1 : 0;
				str += `<th bgcolor="${flag ? "white" : COLORS[(intercept + j) % COLORS.length]}"> </th>`
			}
			for (let i = 0; i < data.length; ++i) {
				str += "<tr>";
				for (let j = 0; j < data[i].length; ++j) {
					const flag = firstIsX && j == 0;
					str += `<td>${flag ? '<b>' : ''}${data[i][j]}${flag ? '</b>' : ''}</td>`
				}
				str += "</tr>";
			}
			str += "</table>";
			return str;
		}
		function getShape(data) {
			let maxrow = data.length, maxcol = 0;
			for (const row of data)
				maxcol = Math.max(maxcol, row.length);
			return [maxrow, maxcol];
		}
		function getMaxX(data) {
			let maxval = 0;
			for (const row of data)
				for (const val of row)
					maxval = Math.max(maxval, val);
			return maxval;
		}
		function getMinMax(data) {
			let minval = null, maxval = null;
			for (const row of data) {
				if (typeof (row) == "number") {
					minval = minval == null ? row : Math.min(minval, row);
					maxval = maxval == null ? row : Math.max(maxval, row);
					continue;
				}
				for (const val of row) {
					minval = minval == null ? val : Math.min(minval, val);
					maxval = maxval == null ? val : Math.max(maxval, val);
				}
			}
			return [minval, maxval];
		}
		// i列目を返す
		function arange(size) {
			return [...new Array(size)].map((_, i) => i);
		}
		// i列目を返す
		function getCol(data, i) {
			return data.map(row => row[i]);
		}
		// 最初の列を無視した結果を返す
		function getIgnoreFirstCol(data) {
			return data.map(row => row.slice(1));
		}
		// いい感じの見た目の数字を返す
		function numberToString(num, precision) {
			const str = num.toPrecision(precision);
			const [base, exp] = str.split("e");
			console.log(base, exp);
			return exp == undefined ? `${Number(base)}` : `${Number(base)}e${Number(exp)}`;
		}
		function plotGraph(xConverter, yConverter, x, y, color = "black", markerSize = 1, lineWidth = 1) {
			let str = "";
			// 折れ線
			if (lineWidth)
				str += `<polyline points="${y.map((yi, i) => xConverter(x[i]) + ',' + yConverter(y[i])).join(' ')}" stroke="${color}" stroke-width="${lineWidth}" fill="transparent"/>`;
			// マーカー
			if (markerSize)
				str += y.map((yi, i) => `<circle cx="${xConverter(x[i])}" cy="${yConverter(yi)}" r="${markerSize}" fill="${color}"/>`).join("");
			return str;
		}
		function makeSVG(dataOrg, firstIsX, property) {
			const xData = firstIsX ? getCol(dataOrg, 0) : arange(dataOrg.length);
			const yData = firstIsX ? getIgnoreFirstCol(dataOrg) : dataOrg;

			const [maxRow, maxCol] = getShape(yData);
			const [xMinVal, xMaxVal] = getMinMax(xData);
			const [yMinVal, yMaxVal] = getMinMax(yData);
			const svgTagWidth = property.width;
			const svgTagHeight = property.height;
			const margin = property.margin;
			const fontSize = property.fontSize;
			const markerSize = property.markerSize;
			const lineWidth = property.lineWidth;
			const gridNum = property.gridNum;
			const precision = property.precision;
			const widthScale = svgTagWidth / (xMaxVal - xMinVal + 1);
			const heightScale = svgTagHeight / (yMaxVal - yMinVal + 1);
			const width = (xMaxVal - xMinVal) * widthScale + 2 * margin;
			const height = (yMaxVal - yMinVal) * heightScale + 2 * margin;

			let svgStr = `<svg viewBox="0 0 ${width} ${height}" width="${svgTagWidth}" height="${svgTagHeight}">`;
			const yConverter = (val) => { return (height - margin) - (val - yMinVal) * heightScale; };
			const xConverter = (val) => { return (val - xMinVal) * widthScale + margin; };
			// x軸
			svgStr += `<line x1="${0}" x2="${width}" y1="${yConverter(yMinVal)}" y2="${yConverter(yMinVal)}" stroke="gray" stroke-width="1"/>`
			// y軸
			svgStr += `<line x1="${xConverter(0)}" x2="${xConverter(0)}" y1="${0}" y2="${height}" stroke="gray" stroke-width="1"/>`
			// 目盛り
			for (let i = 0; i <= gridNum; ++i) {
				const x = xMinVal + (xMaxVal - xMinVal) * i / gridNum;
				const y = yMinVal + (yMaxVal - yMinVal) * i / gridNum;
				// 破線
				svgStr += `<line x1="${0}" y1="${yConverter(y)}" x2="${width}" y2="${yConverter(y)}" stroke="gray" stroke-width="1" stroke-dasharray="5" stroke-opacity="0.5"/>`;
				svgStr += `<line x1="${xConverter(x)}" y1="${0}" x2="${xConverter(x)}" y2="${height}" stroke="gray" stroke-width="1" stroke-dasharray="5" stroke-opacity="0.5"/>`;
				// 数値
				svgStr += `<text x="${xConverter(x)}" y="${yConverter(yMinVal) + fontSize * 1.5}" font-size="${fontSize}" text-anchor="middle">${numberToString(x, precision)}</text>`;
				svgStr += `<text x="${xConverter(0) - fontSize * 0.5}" y="${yConverter(y)}" font-size="${fontSize}" text-anchor="end">${numberToString(y, precision)}</text>`;
			}

			for (let i = 0; i < maxCol; ++i) {
				const y = getCol(yData, i);
				svgStr += plotGraph(xConverter, yConverter, xData, y, COLORS[i % COLORS.length], markerSize, lineWidth);
			}

			svgStr += "</svg>";
			return svgStr;
		}

		// クリック時の処理
		function onClick() {
			const sep = document.getElementById("sep");
			const input = document.getElementById("input");
			// 区切り文字
			const sepToDelimitter = { "tab": "\t", "comma": ",", "space": " " };
			const delimitter = sepToDelimitter[sep.value];
			// 数値に変換
			const data = input.value.trim().split("\n").map(row => row.trim().split(delimitter).map(val => Number(val)));
			const firstIsX = document.getElementById("firstIsX");
			// 読み込み結果を確認
			document.getElementById("data").innerHTML = makeTable(data, firstIsX.checked);
			// プロット
			const property = {
				width: Number(document.getElementById("width").value),
				height: Number(document.getElementById("height").value),
				lineWidth: Number(document.getElementById("lineWidth").value),
				markerSize: Number(document.getElementById("markerSize").value),
				fontSize: Number(document.getElementById("fontSize").value),
				gridNum: Number(document.getElementById("gridNum").value),
				margin: Number(document.getElementById("margin").value),
				precision: Number(document.getElementById("precision").value)
			}
			document.getElementById("graph").innerHTML = makeSVG(data, firstIsX.checked, property);
		}
	</script>
	<footer></footer>
</body>

</html>