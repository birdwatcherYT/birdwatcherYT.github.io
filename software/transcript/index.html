<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>リアルタイム音声文字起こし (オンライン: Web Speech API)</title>
    <link rel="icon" href="https://birdwatcheryt.github.io/image/icon.ico">
    <link rel="stylesheet" type="text/css" href="https://birdwatcheryt.github.io/footer.css">
    <style>
        .app {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        #output {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 100px;
            margin-top: 10px;
            background: #f9f9f9;
            white-space: pre-wrap;
        }

        button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        select {
            margin: 5px;
            padding: 5px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <p><a href="../index.html">←Softwares</a></p>
    <div class="app">
        <h1>リアルタイム音声文字起こし (オンライン: Web Speech API)</h1>

        <label for="languageSelect">言語を選択:</label>
        <select id="languageSelect">
            <option value="ja-JP">日本語</option>
            <option value="en-US">英語（アメリカ）</option>
            <option value="en-GB">英語（イギリス）</option>
            <option value="fr-FR">フランス語</option>
            <option value="de-DE">ドイツ語</option>
            <option value="es-ES">スペイン語（スペイン）</option>
            <option value="it-IT">イタリア語</option>
            <option value="nl-NL">オランダ語</option>
            <option value="pt-BR">ポルトガル語（ブラジル）</option>
            <option value="pt-PT">ポルトガル語（ポルトガル）</option>
            <option value="zh-CN">中国語（簡体字）</option>
            <option value="zh-TW">中国語（繁体字）</option>
            <option value="ko-KR">韓国語</option>
            <option value="ru-RU">ロシア語</option>
            <option value="ar-SA">アラビア語</option>
            <option value="hi-IN">ヒンディー語</option>
            <option value="th-TH">タイ語</option>
            <option value="tr-TR">トルコ語</option>
            <option value="sv-SE">スウェーデン語</option>
            <option value="pl-PL">ポーランド語</option>
            <option value="no-NO">ノルウェー語</option>
            <option value="da-DK">デンマーク語</option>
            <option value="fi-FI">フィンランド語</option>
            <option value="cs-CZ">チェコ語</option>
            <option value="el-GR">ギリシャ語</option>
            <option value="he-IL">ヘブライ語</option>
            <option value="id-ID">インドネシア語</option>
            <option value="ms-MY">マレー語</option>
            <option value="vi-VN">ベトナム語</option>
        </select>

        <label for="separatorSelect">区切り文字を選択:</label>
        <select id="separatorSelect">
            <option value="newline">改行</option>
            <option value="space">スペース</option>
            <option value="kuten">。</option>
            <option value="touten">、</option>
            <option value="period">.</option>
            <option value="comma">,</option>
        </select>

        <div id="output"></div>
        <button id="start">🎤 開始</button>
        <button id="stop" disabled>⏹ 停止</button>
        <button id="save">💾 保存</button>
        <button id="copy">📋 コピー</button>
        <button id="clear">🧹 クリア</button>
    </div>

    <script>
        let recognition = null;
        let finalTranscript = "";
        let isRecording = false;
        const output = document.getElementById("output");
        const startButton = document.getElementById("start");
        const stopButton = document.getElementById("stop");
        const saveButton = document.getElementById("save");
        const copyButton = document.getElementById("copy");
        const clearButton = document.getElementById("clear");
        const languageSelect = document.getElementById("languageSelect");
        const separatorSelect = document.getElementById("separatorSelect");

        const separatorMap = {
            'newline': '\n',
            'space': ' ',
            'kuten': '。',
            'touten': '、',
            'period': '.',
            'comma': ','
        };

        function getCurrentSeparator() {
            return separatorMap[separatorSelect.value] || '\n';
        }

        function startRecognition() {
            if (isRecording) return;

            const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognitionAPI) {
                alert("このブラウザは音声認識をサポートしていません。");
                return;
            }

            isRecording = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            languageSelect.disabled = true;

            const separator = getCurrentSeparator();
            let currentText = output.textContent;
            if (currentText && !Object.values(separatorMap).some(sep => currentText.endsWith(sep))) {
                currentText += separator;
            }
            finalTranscript = currentText;

            recognition = new SpeechRecognitionAPI();
            recognition.lang = languageSelect.value;
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let interimTranscript = "";
                const currentSeparator = getCurrentSeparator();
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        // 結果が空文字や空白のみでない場合だけ、区切り文字を追加する
                        if (transcript.trim() !== '') {
                            finalTranscript += transcript + currentSeparator;
                        }
                    } else {
                        interimTranscript += transcript;
                    }
                }
                output.textContent = finalTranscript + interimTranscript;
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    recognition = null;
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    languageSelect.disabled = false;
                }
            };

            recognition.onerror = (event) => {
                console.error("音声認識エラー:", event.error);
                if (event.error !== 'no-speech') {
                    isRecording = false;
                }
            };

            recognition.start();
        }

        function stopRecognition() {
            if (recognition) {
                isRecording = false;
                recognition.stop();
            }
        }

        startButton.onclick = startRecognition;
        stopButton.onclick = stopRecognition;

        saveButton.onclick = () => {
            const blob = new Blob([output.textContent], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "transcript.txt";
            link.click();
        };

        copyButton.onclick = () => {
            navigator.clipboard.writeText(output.textContent).then(() => {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = "✅ コピー完了";
                copyButton.disabled = true;
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('コピーに失敗しました: ', err);
            });
        };

        clearButton.onclick = () => {
            finalTranscript = "";
            output.textContent = "";
        };
    </script>
    <footer></footer>
</body>

</html>