<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Clock</title>
	<link rel="icon" href="https://birdwatcheryt.github.io/image/icon.ico">
	<link rel="stylesheet" type="text/css" href="https://birdwatcheryt.github.io/footer.css">
	<style>
	.date{
		font-size: 4.5vw;
		font-family: monospace, serif;
	}
	.time{
		font-size: 15vw;
		font-family: monospace, serif;
		font-weight: bold;
	}
	</style>
</head>

<body>
<p><a href="../software.html">←Softwares</a></p>

<h1>System Clock</h1>
<div style="text-align:center;">
	<div id="date" class="date"></div>
	<div id="time" class="time"></div>
</div>
<h1>Alerm</h1>
<input id="alerm_date" type="datetime-local" step="1"/>
<button id="alerm_button" onclick="alerm_click();">Set</button>

<script>
function zeroPadding(num, length) {
	return num.toString().padStart(length, "0");
}

window.AudioContext = window.AudioContext || window.webkitAudioContext;

function play(){
	let ctx = new AudioContext();
	let oscillator = ctx.createOscillator();
	const loop=5;
	let freqs=[700, 0];
	let times=[0.5, 0.1];
	let current_time = ctx.currentTime;
	for (let k=0; k<loop; k++)
	for (let i=0; i<freqs.length; i++){
		oscillator.frequency.setValueAtTime(freqs[i], current_time);
		current_time+=times[i];
	}
	oscillator.connect(ctx.destination);
	oscillator.start(ctx.currentTime);
	oscillator.stop(current_time);
}


let alerm_datetime = null;

function alerm_reset(){
	alerm_datetime = null;
	document.getElementById("alerm_button").textContent="Set";
	document.getElementById("alerm_date").disabled=false;
}
function alerm_set(){
	let alerm_str=document.getElementById("alerm_date").value
	alerm_datetime = new Date(alerm_str);
	if(Number.isNaN(alerm_datetime.getTime())){
		alert("日時を設定してください");
		alerm_datetime = null;
		return;
	}
	let date = new Date();
	if(date.getTime()>=alerm_datetime.getTime()){
		alert("現在時刻より未来の時刻を設定してください");
		alerm_datetime = null;
		return;
	}
	document.getElementById("alerm_button").textContent="Reset";
	document.getElementById("alerm_date").disabled=true;
}
function alerm_check(){
	if(alerm_datetime == null)
		return;
	let date = new Date();
	if(date.getTime()>=alerm_datetime.getTime()){
		play();
		// alert(alerm_datetime.toLocaleString());
		alerm_reset();
	}
}
function alerm_click(){
	if(alerm_datetime==null){
		alerm_set();
	}else{
		alerm_reset();
	}
}

const WEEKDAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
function clock() {
	let date = new Date();
	let year = zeroPadding( date.getFullYear(), 4 );
	let month = zeroPadding( date.getMonth()+1, 2 );
	let day = zeroPadding( date.getDate(), 2 );
	let weekday = WEEKDAYS[date.getDay()];
	let hour = zeroPadding( date.getHours(), 2);
	let minute  = zeroPadding( date.getMinutes(), 2 );
	let second  = zeroPadding( date.getSeconds(), 2 );
	document.getElementById("date").innerHTML = year + "/" + month + "/" + day + " " + weekday;
	document.getElementById("time").innerHTML = hour + ":" + minute + ":" + second;
}

clock();
setTimeout(() => {
	clock();
	try {
		// バックグラウンド対応
		const code = "self.addEventListener('message', msg=>{setInterval(()=>self.postMessage(null), msg.data)})";
		const w = new Worker("data:text/javascript;base64," + btoa(code));
		w.onmessage = () => {
			clock();alerm_check();
		};
		w.postMessage(1000);
	} catch(_){
		// Workerが使えないとき
		console.log("cannot use worker");
		const id = setInterval("clock();alerm_check();", 1000);
	}
}, 1000 - new Date().getMilliseconds());


</script>
<footer></footer>

</body>
</html>
